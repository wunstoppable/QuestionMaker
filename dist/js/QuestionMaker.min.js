var app=angular.module("QMaker",["ui.router"]);app.run(function($rootScope,$state,$stateParams){$rootScope.$state=$state,$rootScope.$stateParams=$stateParams}),app.controller("questionListCtrl",["$scope","QuestionService",function($scope,QuestionService){var getList=function(pageNo,pageSize){QuestionService.getQuestions(pageNo,pageSize).success(function(data){data.success?($scope.questionList=data.data.questions,$scope.pageObject.itemsCount=data.data.total):alert(data.error)})};$scope.pageObject={itemsCount:0,pageSize:3,pageNo:1},$scope.pageFunction=function(){getList($scope.pageObject.pageNo,$scope.pageObject.pageSize)},getList($scope.pageObject.pageNo,$scope.pageObject.pageSize),$scope.removeQuestion=function(id){QuestionService.remove(id).success(function(data){if(data.success)for(var i=0;i<$scope.questionList.length;i++){var q=$scope.questionList[i];if(q.id===id){$scope.questionList.splice(i,1);break}}else alert(data.error)})},window.scope=$scope}]).controller("questionCtrl",["$scope","$rootScope","$http","$location","QuestionService","$filter",function($scope,$rootScope,$http,$location,QuestionService,$filter){var id=$rootScope.$state.params.id,type=$rootScope.$state.current.name.split(".")[1],initData=function(type){switch(type){case"choice":$scope.formData.qtype=1,$scope.formData.options=[{},{},{},{}],$scope.formData.answer=0;break;case"block":$scope.formData.qtype=2,$scope.formData.options=null,$scope.formData.answer=[]}},subscirbeCont=function(type){"block"==type&&$scope.$watch("formData.content",function(newValue,oldValue){newValue=newValue||"",oldValue=oldValue||"";var newBlocks=newValue.match(/\$\$/g)||[],oldBlocks=oldValue.match(/\$\$/g)||[];if(newBlocks.length!==oldBlocks.length){for(var answer=[],i=0;i<newBlocks.length;i++){var a=$scope.formData.answer[i]||i+1;answer.push(a)}$scope.formData.answer=answer}})};0!=id?QuestionService.getQuestion(id).success(function(data){$scope.formData=data.data,$filter("qtypestr_en")(data.data.qtype)!=type?initData(type):$scope.formData.answer=data.data.answer.split(",")}):($scope.formData={id:0,name:""},initData(type)),$scope.qtypes=[1,2],subscirbeCont(type),$scope.removeOption=function(index){$scope.formData.options.splice(index,1)},$scope.addOption=function(){$scope.formData.options.push({name:""})},$scope.changeTpl=function(){var type=$filter("qtypestr_en")($scope.formData.qtype);$rootScope.$state.go("questionEdit."+type,{type:type}),initData(type),subscirbeCont(type)},$scope.submit=function(){0!=id?QuestionService.update($scope.formData).success(function(data){data.success?alert("修改成功！"):alert(data.error)}):QuestionService.submit($scope.formData).success(function(data){data.success?alert("提交成功！"):alert(data.error)})},window.scope=$scope}]).controller("paperListCtrl",["$scope","PaperService",function($scope,PaperService){var getList=function(pageNo,pageSize){PaperService.getPapers(pageNo,pageSize).success(function(data){data.success?($scope.paperList=data.data.papers,$scope.pageObject.itemsCount=data.data.total):alert(data.error)})};$scope.pageObject={itemsCount:0,pageSize:3,pageNo:1},$scope.pageFunction=function(){getList($scope.pageObject.pageNo,$scope.pageObject.pageSize)},getList($scope.pageObject.pageNo,$scope.pageObject.pageSize),$scope.removePaper=function(id){PaperService.remove(id).success(function(data){if(data.success)for(var i=0;i<$scope.paperList.length;i++){var p=$scope.paperList[i];if(p.id===id){$scope.paperList.splice(i,1);break}}else alert(data.error)})},window.scope=$scope}]).controller("paperCtrl",["$scope","$rootScope","$http","$location","PaperService",function($scope,$rootScope,$http,$location,PaperService){var id=$rootScope.$state.params.id;$scope.questions=[],0==id?$scope.formData={id:id,name:"",questionIds:[]}:PaperService.getPaper(id).success(function(data){data.success?$scope.formData=data.data:alert("获取试卷信息失败！")}),PaperService.getQuestions(id).success(function(data){data.success?$scope.questions=data.data:alert("加载题目失败！")}),$scope.submit=function(){$scope.formData.questionIds=[],$scope.questions.forEach(function(e){e.checked&&$scope.formData.questionIds.push(e.id)}),0==id?PaperService.submit($scope.formData).success(function(data){data.success?alert("提交成功！"):alert(data.error)}):PaperService.update($scope.formData).success(function(data){data.success?alert("修改成功！"):alert(data.error)})},window.scope=$scope}]).controller("paperPreviewCtrl",["$scope","$rootScope","PaperService",function($scope,$rootScope,PaperService){var id=$rootScope.$state.params.id;$scope.questions=[],PaperService.getPaper(id).success(function(data){data.success?$scope.paper=data.data:alert("获取试卷信息失败！")}),PaperService.getQuestions(id).success(function(data){data.success?$scope.questions=data.data:alert("加载题目失败！")}),window.scope=$scope}]),app.directive("pagenav",function(){return{restrict:"E",replace:!0,scope:{page:"=pageobj",query:"=pagefunc"},link:function($scope,$element){$scope.createHtml=function(){var maxPage=Math.ceil($scope.page.itemsCount/$scope.page.pageSize),pageNo=$scope.page.pageNo,str='<nav><ul class="pagination">';if(maxPage>10){pageNo>3&&(str+='<li><a href="javascript:void(0);" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>',str+="<li><span>...</span></li>");for(var i=pageNo<=2?1:pageNo-2;i<=(pageNo>=maxPage-2?maxPage:pageNo+2);i++)1==i?1==pageNo?(str+='<li class="disabled"><a href="javascript:void(0);" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>',str+='<li class="active"><a href="javascript:void(0);">'+i+"</a></li>"):(str+='<li><a href="javascript:void(0);" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>',str+='<li><a href="javascript:void(0);">'+i+"</a></li>"):i==maxPage?pageNo==maxPage?(str+='<li class="active"><a>'+i+"</a></li>",str+='<li><a href="javascript:void(0);" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>'):(str+='<li><a href="javascript:void(0);">'+i+"</a></li>",str+='<li><a href="javascript:void(0);" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>'):str+=pageNo==i?'<li class="active"><a href="javascript:void(0);">'+i+"</a></li>":'<li><a href="javascript:void(0);">'+i+"</a></li>";pageNo<maxPage-2&&(str+="<li><span>...</span></li>",str+='<li><a href="javascript:void(0);" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>')}else for(var i=1;i<=maxPage;i++)1==i?1==pageNo?(str+='<li class="disabled"><a href="javascript:void(0);" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>',str+='<li class="active"><a href="javascript:void(0);">'+i+"</a></li>"):(str+='<li><a href="javascript:void(0);" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>',str+='<li><a href="javascript:void(0);">'+i+"</a></li>"):i==maxPage?pageNo==maxPage?(str+='<li class="active"><a href="javascript:void(0);">'+i+"</a></li>",str+='<li class="disabled"><a href="javascript:void(0);" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>'):(str+='<li><a href="javascript:void(0);">'+i+"</a></li>",str+='<li><a href="javascript:void(0);" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>'):str+=pageNo==i?'<li class="active"><a href="javascript:void(0);">'+i+"</a></li>":'<li><a href="javascript:void(0);">'+i+"</a></li>";str+="</ul></nav>",$element.html(str),$scope.bindEvent()},$scope.bindEvent=function(){$element.find("a").on("click",function(){var direction=$(this).attr("aria-label"),text=$(this).text(),li=$(this).closest("li"),pageNo=$scope.page.pageNo;if("Previous"==direction){if(li.hasClass("disabled"))return;$scope.page.pageNo=pageNo-1}else if("Next"==direction){if(li.hasClass("disabled"))return;$scope.page.pageNo=pageNo+1}else $scope.page.pageNo=parseInt(text);$scope.query(),$scope.createHtml()})},$scope.createHtml(),$scope.$watch("page.itemsCount",function(){$scope.createHtml()})}}}),app.filter("qtypestr",function(){return function(type){switch(type){case 1:return"选择";case 2:return"填空"}}}).filter("qtypestr_en",function(){return function(type){switch(+type){case 1:return"choice";case 2:return"block"}}}).filter("qtypestr_en_to_num",function(){return function(type){switch(type){case"choice":return 1;case"block":return 2}}}).filter("optionstr",function(){return function(index){return String.fromCharCode(index+65)}}).filter("blockfilter",function(){return function(cont){return cont=cont||"",cont.replace(/\$\$/g,"______")}}),app.config(function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/home"),$stateProvider.state("home",{url:"/home",templateUrl:"/dist/tpl/home.html"}).state("questionList",{url:"/questionList",templateUrl:"/dist/tpl/questionList.html",controller:"questionListCtrl"}).state("questionEdit",{url:"/questionEdit/id/:id",templateUrl:"/dist/tpl/questionEdit.html",controller:"questionCtrl"}).state("questionEdit.choice",{url:"/type/choice",views:{editArea:{templateUrl:"/dist/tpl/choice.html"},previewArea:{templateUrl:"/dist/tpl/choiceView.html"}}}).state("questionEdit.block",{url:"/type/block",views:{editArea:{templateUrl:"/dist/tpl/block.html"},previewArea:{templateUrl:"/dist/tpl/blockView.html"}}}).state("paperList",{url:"/paperList",templateUrl:"/dist/tpl/paperList.html",controller:"paperListCtrl"}).state("paperEdit",{url:"/paperEdit/id/:id",templateUrl:"/dist/tpl/paperEdit.html",controller:"paperCtrl"}).state("paperEdit.preview",{url:"/",views:{choicePreview:{templateUrl:"/dist/tpl/choiceView.html"},blockPreview:{templateUrl:"/dist/tpl/blockView.html"}}}).state("paperPreview",{url:"/paperPreview/id/:id",templateUrl:"/dist/tpl/paperPreview.html",controller:"paperPreviewCtrl"}).state("paperPreview.preview",{url:"/",views:{choicePreview:{templateUrl:"/dist/tpl/choiceView.html"},blockPreview:{templateUrl:"/dist/tpl/blockView.html"}}})}),app.service("QuestionService",["$http",function($http){this.submit=function(formData){return $http.post("/api/submitQuestion",{question:formData})},this.getQuestion=function(id){return $http.post("/api/getQuestion",{id:id})},this.getQuestions=function(pageNo,pageSize){return $http.post("/api/getQuestions",{pageNo:pageNo,pageSize:pageSize})},this.update=function(formData){return $http.post("/api/updateQuestion",{question:formData})},this.remove=function(id){return $http.post("/api/removeQuestion",{id:id})}}]).service("PaperService",["$http",function($http){this.getPapers=function(pageNo,pageSize){return $http.post("/api/getPapers",{pageNo:pageNo,pageSize:pageSize})},this.getPaper=function(id){return $http.post("/api/getPaper",{id:id})},this.getQuestions=function(id){return $http.post("/api/getPaperQuestions",{id:id})},this.submit=function(formData){return $http.post("/api/submitPaper",{paper:formData})},this.update=function(formData){return $http.post("/api/updatePaper",{paper:formData})},this.remove=function(id){return $http.post("/api/removePaper",{id:id})}}]);